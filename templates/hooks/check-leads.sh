#!/bin/bash
# CCT Hook: Check lead status and questions
# Runs after every tool call via PostToolUse hook

# Find project root (where .outputs is)
if [ -d ".outputs" ]; then
  OUTPUTS_DIR=".outputs"
elif [ -d "../../.outputs" ]; then
  OUTPUTS_DIR="../../.outputs"
else
  exit 0
fi

# Check for completed leads
shopt -s nullglob
for status_file in "$OUTPUTS_DIR"/*.status; do
  [ -f "$status_file" ] || continue

  status=$(cat "$status_file")
  lead=$(basename "$status_file" .status)

  case "$status" in
    DONE)
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ğŸ“¬ LEAD '$lead' Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ˜Ğ› Ğ ĞĞ‘ĞĞ¢Ğ£"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      result_file="$OUTPUTS_DIR/${lead}.md"
      if [ -f "$result_file" ]; then
        echo ""
        echo "Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: $result_file"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        head -100 "$result_file"
        lines=$(wc -l < "$result_file")
        if [ "$lines" -gt 100 ]; then
          echo ""
          echo "[...Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 100 Ğ¸Ğ· $lines ÑÑ‚Ñ€Ğ¾Ğº]"
        fi
      fi
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # Mark as processed
      mv "$status_file" "$status_file.processed"
      ;;

    ERROR)
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âŒ LEAD '$lead' Ğ¡ĞĞĞ‘Ğ©ĞĞ•Ğ¢ ĞĞ‘ ĞĞ¨Ğ˜Ğ‘ĞšĞ•"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      error_file="$OUTPUTS_DIR/${lead}.error"
      if [ -f "$error_file" ]; then
        cat "$error_file"
      fi
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      mv "$status_file" "$status_file.processed"
      ;;

    WAITING)
      # Lead is waiting for something, don't process yet
      ;;

    IN_PROGRESS)
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ğŸ”„ LEAD/WORKER '$lead' ĞĞĞ§ĞĞ› Ğ ĞĞ‘ĞĞ¢Ğ£"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # Mark as acknowledged (don't process again)
      mv "$status_file" "$status_file.ack"
      ;;
  esac
done

# Show notifications from background watcher (if running)
NOTIFY_LOG="$OUTPUTS_DIR/_notifications.log"
if [ -f "$NOTIFY_LOG" ] && [ -s "$NOTIFY_LOG" ]; then
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "ğŸ“‹ BACKGROUND NOTIFICATIONS"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  cat "$NOTIFY_LOG"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  # Clear after showing
  > "$NOTIFY_LOG"
fi

# Check for questions from leads
for question_file in "$OUTPUTS_DIR"/*.question; do
  [ -f "$question_file" ] || continue

  lead=$(basename "$question_file" .question)

  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "â“ Ğ’ĞĞŸĞ ĞĞ¡ ĞĞ¢ LEAD '$lead'"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  cat "$question_file"
  echo ""
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ, Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¸ Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ¼ ĞµĞ³Ğ¾ Ğ»Ğ¸Ğ´Ñƒ."
  echo "Ğ¤Ğ°Ğ¹Ğ» Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°: $question_file"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
done
